@using Shared.Application.Utility

@model Users1.Application.Contract.UserService.Query.FilteredUsersQueryModel
@{
	ViewData["Title"] = "کاربران سایت";
	ViewData["Selected"] = "Users";
	
	var counter = 0;
	
}

@section HeaderContent{
	
	
	<form class="form-inline ml-3  float-sm" asp-action="Index"  method="get">
		<div class="input-group input-group-sm " style=" display: flex;
		                                                align-items: center; width: 300px; margin-right: 400px; padding : 10px"  >
		
			<input class="form-control "  type="search" placeholder="نام کاربری یا موبایل را وارد کنید..." aria-label="Search" name="q" value="@Model.FilterParams.Title">
			<button class="btn btn-sm btn-success " style="margin-right: 6px" type="submit">
				<i class="fa fa-search">جستجو</i>
			</button>
			<div class="input-group-append ">

			</div>
		</div>
		<hr>
	</form>

}

<div class="table-responsive-md">
	<table class="table table-bordered text-sm table-sm  table-hover ">

		<thead class="">

		<tr>
			<th class="">#</th>
			<th class="col-2">نام کابری</th>
			<th class="col-2">موبایل</th>
			<th class="col-2">آواتار</th>
			<th class="col-1"> نقش ها</th>
			<th class="col-4">عملیات</th>
		</tr>

		</thead>
		<tbody>

		@if (  Model.Users.Any())
		{
			@foreach (var user in Model.Users)
			{
				<tr>
					<td>@(counter += 1)</td>

					<td>
						@user.UserName
					</td>

					<td>
						@user.Mobile
					</td>
					<td class="mr-3 mt-3">
						<img src="@Directories.GetUserAvatarFullPath(@user.Avatar,100)" width="100" height="100" alt="user-avatar" /></td>
					
					<td>
						@foreach (var role in @user.Roles)
						{
							@role.Title

							<a class="btn btn-danger mr-1" onclick="deleteUserRole('@user.userId','@role.Id')">حذف</a>
						}
					
					</td>

					<td class="btn-group-sm">

						<a class="btn   btn-primary mr-1" href="/Admin/Users/EditUser?userId=@user.userId" >
							ویرایش
						</a>
						@if (@user.IsActive)
						{
							@* <ajax-change-activation-button url="/Admin/Home?handler=ChangeUserActivation&userId=@user.userId" error-text="عملیات انجام نشد " error-title="" btn-color="danger">غیر فعال کردن</ajax-change-activation-button> *@

								<a class="btn btn-danger" onclick="changeActivation('/Admin/Users/ChangeUserActivation/@user.userId')"> غیر فعال کردن کاربر</a>
						}
						else
						{
							@* 	<ajax-change-activation-button url="/Admin/Home?handler=ChangeUserActivation&userId=@user.userId" btn-color="primary"> فعال کردن</ajax-change-activation-button> *@


								<a class="btn btn-primary " onclick="changeActivation('/Admin/Users/ChangeUserActivation/@user.userId')">  فعال کردن کاربر</a>
						}
						
						<!-- Button trigger modal -->
						<a  class="btn btn-primary" onclick="getAddRoleToUserModel('@user.userId')"  data-toggle="modal" data-target="#exampleModal">
						 	 افزودن نقش جدید به کاربر
						</a>
						
						
						<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
							
						</div>
					   

					</td>
				</tr>


			}

			if (Model.TotalPages > 1)
			{
				<div class="row">
					<ul class="pagination pagination-sm " style="margin-right: 500px">
						@if (Model.CurrentPage > 1)
						{
							<li class="page-item"><a disabled class="page-link" asp-area="Admin" asp-controller="Home" asp-action="Index" asp-route-pageId="@(Model.CurrentPage-1)" asp-route-q="@Model.FilterParams.Title" >&laquo;</a></li>
						}
						@for (var i = Model.StartPage; i <= Model.EndPage; i++)
						{
								<li class="page-item"><a href="/Admin/Home/Users?pageId=@i&q=@Model.FilterParams.Title" class="page-link"  @((i == Model.CurrentPage ? "class='disabled-link'" : ""))>@i</a></li>
						}
						@if (Model.CurrentPage < Model.EndPage)
						{
								<li class="page-item"><a class="page-link" href="/Admin/Home/Users?pageId=@Model.CurrentPage+1&q=@Model.FilterParams.Title">&raquo;</a></li>
						}

					</ul>
				</div>

			}
		}
		else
		{
			<h1>چیزی برای نمایش وجود ندارد...</h1>
		}

		</tbody>
	</table>
</div>

						@section Scripts
						{
							<script>
								function changeActivation(url, errorTitle, errorText) {
									if (errorTitle == null || errorTitle == "undefined") {
										errorTitle = "عملیات ناموفق";
									}
									if (errorText == null || errorText == "undefined") {
										errorText = "";
									}
									Swal.fire({
										title: "هشدار !!",
										text: "آیا از انجام عملیات اطمینان دارید ؟",
										icon: "warning",
										confirmButtonText: "بله",
										showCancelButton: true,
										cancelButtonText: "خیر",
										preConfirm: () => {
											$.ajax({
												url: url,
												type: "get",
												beforeSend: function() {
													$(".loading").show();
												},
												complete: function() {
													$(".loading").hide();
												},
												error: function(data) {
													ErrorAlert("مشکلی در اعملیات رخ داده", "لطفا در زمان دیگری امتحان کنید");
												}
											}).done(function(result) {
												{

													if (result.success) {
														Success(result.title, result.message);
													} else {
														ErrorAlert(result.title, result.message);
													}

													setTimeout(function(parameters) {
															location.reload();
														},
														2000);
												}
											});


										}
									});
								}

								function deleteUserRole(userId, roleId) {

									Swal.fire({
										title: "هشدار !!",
										text: "آیا از انجام عملیات اطمینان دارید ؟",
										icon: "warning",
										confirmButtonText: "بله",
										showCancelButton: true,
										cancelButtonText: "خیر",
										preConfirm: () => {
											$.ajax({
												url: `/Admin/Roles/DeleteUserRole?userId=${userId}&roleId=${roleId}`,
												type: "get",
												beforeSend: function() {
													$(".loading").show();
												},
												complete: function() {
													$(".loading").hide();
												},
												error: function(data) {
													ErrorAlert("مشکلی در اعملیات رخ داده", "لطفا در زمان دیگری امتحان کنید");
												}
											}).done(function(result) {
												{
													if (result.success) {
														Success(result.title, result.message);
													} else {
														ErrorAlert(result.title, result.message);
													}

													setTimeout(function(parameters) {
															location.reload();
														},
														2000);
												}
											});


										}
									});
								}


								function getAddRoleToUserModel(userId) {


									$.ajax({
										url: `/Admin/Roles/GetRolesForAddRoleToUser?userId=${userId}`,
										type: "get",
										error: function(data) {
											ErrorAlert("مشکلی در اعملیات رخ داده", "لطفا در زمان دیگری امتحان کنید");
										}

									}).done(function(data) {
										$("#exampleModal").html('');
										$("#exampleModal").append(data);

									});
								}
							</script>



						}
